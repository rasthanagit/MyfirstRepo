name: Deploy Parameter Store

on:
  workflow_dispatch:
    inputs:
      scope:
        description: "Parameter scope (common | env)"
        required: true
        type: choice
        options:
          - common
          - env
      environment:
        description: "Environment (required if scope=env)"
        required: false
        type: choice
        options:
          - dev
          - qa
          - stage
          - prod

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'qa' }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.IAM_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build and Deploy Parameters
        shell: bash
        env:
          COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
        run: |
          SCOPE="${{ github.event.inputs.scope }}"
          DEPLOY_ENV="${{ github.event.inputs.environment || 'qa' }}"

          if [ "$SCOPE" == "common" ]; then
            STACK_NAME="parameter-store-common"
            DEPLOY_ENV="qa"
          else
            STACK_NAME="parameter-store-$DEPLOY_ENV"
          fi

          normalize() {
            if [ -z "$1" ]; then
              echo "none"
            else
              echo "$1"
            fi
          }

          echo "Deploying stack: $STACK_NAME"

          aws cloudformation deploy \
            --template-file template.yaml \
            --stack-name "$STACK_NAME" \
            --region "$AWS_REGION" \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset \
            --s3-bucket gunner-cft-template-us-east2 \
            --parameter-overrides \
              Scope="$SCOPE" \
              environment="$DEPLOY_ENV" \
              COGNITOCLIENTIDValue="$(normalize "$COGNITO_CLIENT_ID")"
              # COGNITOCLIENTIDValue="$(normalize '${{ secrets.COGNITO_CLIENT_ID }}')"
              # Param2COGNITOUSERPOOLIDValue="$(normalize '${{ secrets.COGNITO_USER_POOL_ID }}')" \
              # Param3DOCUSIGNACCOUNTIDValue="$(normalize '${{ secrets.DOCUSIGN_ACCOUNT_ID }}')" \
              # Param4DOCUSIGNAUTHDOMAINValue="$(normalize '${{ secrets.DOCUSIGN_AUTH_DOMAIN }}')" \
              # Param5DOCUSIGNINTEGRATIONKEYValue="$(normalize '${{ secrets.DOCUSIGN_INTEGRATION_KEY }}')" \
              # Param6DOCUSIGNPRIVATEKEYValue="$(normalize '${{ secrets.DOCUSIGN_PRIVATE_KEY }}')" \
              # Param7DOCUSIGNUSERGUIDValue="$(normalize '${{ secrets.DOCUSIGN_USER_GUID }}')" \
              # Param8CONTRACTPAYMENTSCHEDULEAPIValue="$(normalize '${{ secrets.CONTRACT_PAYMENT_SCHEDULE_API }}')" \
              # Param9CONTRACTPORTALHMACSECRETValue="$(normalize '${{ secrets.CONTRACT_PORTAL_HMAC_SECRET }}')" \
              # Param10CONTRACTSENDAPIValue="$(normalize '${{ secrets.CONTRACT_SEND_API }}')" \
              # Param11CONTRACTSOWAPIValue="$(normalize '${{ secrets.CONTRACT_SOW_API }}')" \
              # Param12CONTRACTSTORAGEBUCKETNAMEValue="$(normalize '${{ secrets.CONTRACT_STORAGE_BUCKET_NAME }}')" \
              # Param13CONTRACTTERMAPIValue="$(normalize '${{ secrets.CONTRACT_TERM_API }}')" \
              # Param14DBCONNECTIONSTRINGValue="$(normalize '${{ secrets.DB_CONNECTION_STRING }}')" \
              # Param15DEFAULTSALESADMINDETAILSValue="$(normalize '${{ secrets.DEFAULT_SALES_ADMIN_DETAILS }}')" \
              # Param16DOCUMENTDBTOPICARNValue="$(normalize '${{ secrets.DOCUMENT_DB_TOPIC_ARN }}')" \
              # Param17FRONTENDURLValue="$(normalize '${{ secrets.FRONTEND_URL }}')" \
              # Param18HRPORTALROLESValue="$(normalize '${{ secrets.HR_PORTAL_ROLES }}')" \
              # Param19INTEGRATIONTOKENValue="$(normalize '${{ secrets.INTEGRATION_TOKEN }}')" \
              # Param20LOCATIONDATASTREAMValue="$(normalize '${{ secrets.LOCATION_DATASTREAM }}')" \
              # Param21MEDIABUCKETValue="$(normalize '${{ secrets.MEDIA_BUCKET }}')" \
              # Param22OPERATIONSPORTALROLESValue="$(normalize '${{ secrets.OPERATIONS_PORTAL_ROLES }}')" \
              # Param23PACKAGEAPIURLValue="$(normalize '${{ secrets.PACKAGE_API_URL }}')" \
              # Param24PASSWORDLESSLOGINTOKENEXPIRYValue="$(normalize '${{ secrets.PASSWORD_LESS_LOGIN_TOKEN_EXPIRY }}')" \
              # Param25PRICINGAPIURLValue="$(normalize '${{ secrets.PRICING_API_URL }}')" \
              # Param26PROPOSALBUCKETNAMEValue="$(normalize '${{ secrets.PROPOSAL_BUCKET_NAME }}')" \
              # Param27PROPOSALCALLBACKURLValue="$(normalize '${{ secrets.PROPOSAL_CALLBACK_URL }}')" \
              # Param28REGIONValue="$(normalize '${{ secrets.REGION }}')" \
              # Param29SALESPORTALROLESValue="$(normalize '${{ secrets.SALES_PORTAL_ROLES }}')" \
              # Param30SMTPDETAILSValue="$(normalize '${{ secrets.SMTP_DETAILS }}')" \
              # Param31SNSARNValue="$(normalize '${{ secrets.SNS_ARN }}')" \
              # Param32TOKENVALIDATEENDPOINTValue="$(normalize '${{ secrets.TOKEN_VALIDATE_END_POINT }}')" \
              # Param33DOCUSIGNBASEPATHValue="$(normalize '${{ secrets.DOCUSIGN_BASE_PATH }}')" \
              # Param34EMAILFROMEMAILValue="$(normalize '${{ secrets.EMAIL_FROM_EMAIL }}')" \
              # Param35EMAILTEMPLATEGLOBALVARSValue="$(normalize '${{ secrets.EMAIL_TEMPLATE_GLOBAL_VARS }}')" \
              # Param36GUNNERNONSERVICESTATEValue="$(normalize '${{ secrets.GUNNER_NON_SERVICE_STATE }}')" \
              # Param37HUBSPOTAPIKEYValue="$(normalize '${{ secrets.HUBSPOT_API_KEY }}')" \
              # Param38HUBSPOTDEALSTAGEValue="$(normalize '${{ secrets.HUBSPOT_DEALSTAGE }}')" \
              # Param39MSIDENTIFIERValue="$(normalize '${{ secrets.MS_IDENTIFIER }}')" \
              # Param40MSMEASUREMENTSERVICEURLValue="$(normalize '${{ secrets.MS_MEASUREMENT_SERVICE_URL }}')" \
              # Param41MSSNSDBTOPICARNValue="$(normalize '${{ secrets.MS_SNS_DB_TOPIC_ARN }}')" \
              # Param42MSSNSPROVIDERTOPICARNValue="$(normalize '${{ secrets.MS_SNS_PROVIDER_TOPIC_ARN }}')" \
              # Param43MSVENDORAPIKEYValue="$(normalize '${{ secrets.MS_VENDOR_API_KEY }}')" \
              # Param44MSVENDORBUCKETNAMEValue="$(normalize '${{ secrets.MS_VENDOR_BUCKET_NAME }}')" \
              # Param45MSVENDORFILENAMEValue="$(normalize '${{ secrets.MS_VENDOR_FILE_NAME }}')" \
              # Param46REDISREADCONNECTIONValue="$(normalize '${{ secrets.REDIS_READ_CONNECTION }}')" \
              # Param47REDISWRITECONNECTIONValue="$(normalize '${{ secrets.REDIS_WRITE_CONNECTION }}')" \
              # Param48SNOWFLAKEACCOUNTValue="$(normalize '${{ secrets.SNOWFLAKE_ACCOUNT }}')" \
              # Param49SNOWFLAKEDATABASEValue="$(normalize '${{ secrets.SNOWFLAKE_DATABASE }}')" \
              # Param50SNOWFLAKEPASSWORDValue="$(normalize '${{ secrets.SNOWFLAKE_PASSWORD }}')" \
              # Param51SNOWFLAKEROLEValue="$(normalize '${{ secrets.SNOWFLAKE_ROLE }}')" \
              # Param52SNOWFLAKESCHEMAValue="$(normalize '${{ secrets.SNOWFLAKE_SCHEMA }}')" \
              # Param54SNOWFLAKEUSERNAMEValue="$(normalize '${{ secrets.SNOWFLAKE_USERNAME }}')" \
              # Param55SNOWFLAKEWAREHOUSEValue="$(normalize '${{ secrets.SNOWFLAKE_WAREHOUSE }}')" \
              # Param56SNSTOPICDOCUMENTValue="$(normalize '${{ secrets.SNS_TOPIC_DOCUMENT }}')" \
              # Param57SNSTOPICNOTIFICATIONSERVICEValue="$(normalize '${{ secrets.SNS_TOPIC_NOTIFICATION_SERVICE }}')" \
              # Param58SNSTOPICPROJECTValue="$(normalize '${{ secrets.SNS_TOPIC_PROJECT }}')" \
              # Param59SNSTOPICSNSPUSHNOTIFICATIONValue="$(normalize '${{ secrets.SNS_TOPIC_SNS_PUSH_NOTIFICATION }}')" \
              # Param60DOCUSIGNACCOUNTEMAILValue="$(normalize '${{ secrets.DOCUSIGN_ACCOUNT_EMAIL }}')" \
              # Param61DOCUSIGNACCOUNTNAMEValue="$(normalize '${{ secrets.DOCUSIGN_ACCOUNT_NAME }}')" \
              # Param62DOCUSIGNCALLBACKREDIRECTURLValue="$(normalize '${{ secrets.DOCUSIGN_CALLBACK_REDIRECT_URL }}')" \
              # Param63DOCUSIGNCALLBACKURLValue="$(normalize '${{ secrets.DOCUSIGN_CALLBACK_URL }}')" \
              # Param64DOCUSIGNSECRETKEYValue="$(normalize '${{ secrets.DOCUSIGN_SECRET_KEY }}')" \
              # Param65DOCUSIGNSELLERFULLNAMEValue="$(normalize '${{ secrets.DOCUSIGN_SELLER_FULLNAME }}')" \
              # Param66DOCUSIGNBASEURLValue="$(normalize '${{ secrets.DOCUSIGN_BASE_URL }}')" \
              # Param67DOCUSIGNSELLEREMAILValue="$(normalize '${{ secrets.DOCUSIGN_SELLER_EMAIL }}')" \
              # Param68CONTRACTPORTALAPIValue="$(normalize '${{ secrets.CONTRACT_PORTAL_API }}')" \
              # Param69CONTRACTPREVIEWBUCKETNAMEValue="$(normalize '${{ secrets.CONTRACT_PREVIEW_BUCKET_NAME }}')" \
              # Param70CONTRACTSIGNATUREURLValue="$(normalize '${{ secrets.CONTRACT_SIGNATURE_URL }}')" \
              # Param71CONTRACTTEMPLATEBUCKETNAMEValue="$(normalize '${{ secrets.CONTRACT_TEMPLATE_BUCKET_NAME }}')" \
              # Param72HOVERCALLBACKAPIURLValue="$(normalize '${{ secrets.HOVER_CALLBACK_API_URL }}')" \
              # Param73HOVERMEASUREMENTAPIURLValue="$(normalize '${{ secrets.HOVER_MEASUREMENT_API_URL }}')" \
              # Param74HOVERAUTHTOKENURLValue="$(normalize '${{ secrets.HOVER_AUTH_TOKEN_URL }}')" \
              # Param75HOVERCLIENTIDValue="$(normalize '${{ secrets.HOVER_CLIENT_ID }}')" \
              # Param76HOVERCLIENTSECRETValue="$(normalize '${{ secrets.HOVER_CLIENT_SECRET }}')" \
              # Param77HOVERHOVEREVENTTOPICValue="$(normalize '${{ secrets.HOVER_EVENT_TOPIC }}')" \
              # Param78HOVERISENABLEDValue="$(normalize '${{ secrets.HOVER_IS_ENABLED }}')" \
              # Param79HOVERREFRESHTOKENBUCKETValue="$(normalize '${{ secrets.HOVER_REFRESH_TOKEN_BUCKET }}')" \
              # Param80HOVERTOHOVERTOPICValue="$(normalize '${{ secrets.HOVER_TO_HOVER_TOPIC }}')" \
              # Param81HUBSPOTAPIKEYTEMPValue="$(normalize '${{ secrets.HUBSPOT_API_KEY_TEMP }}')" \
              # Param82HUBSPOTDEALCREATEURLValue="$(normalize '${{ secrets.HUBSPOT_DEAL_CREATE_URL }}')" \
              # Param83HUBSPOTHUBSPOTTOQPDEALTOPICARNValue="$(normalize '${{ secrets.HUBSPOT_TO_QP_DEAL_TOPIC_ARN }}')" \
              # Param84PROPOSALACCEPTURLValue="$(normalize '${{ secrets.PROPOSAL_ACCEPT_URL }}')" \
              # Param85PROPOSALCALLBACKREDIRECTURLValue="$(normalize '${{ secrets.PROPOSAL_CALLBACK_REDIRECT_URL }}')" \
              # Param87PROPOSALPREVIEWBUCKETNAMEValue="$(normalize '${{ secrets.PROPOSAL_PREVIEW_BUCKET_NAME }}')" \
              # Param88PROPOSALTEMPLATEBUCKETNAMEValue="$(normalize '${{ secrets.PROPOSAL_TEMPLATE_BUCKET_NAME }}')" \
              # Param89EMAILFROMCOIEMAILValue="$(normalize '${{ secrets.EMAIL_FROM_COI_EMAIL }}')" \
              # Param90GUNNERJWTSECRETKEYValue="$(normalize '${{ secrets.GUNNER_JWT_SECRET_KEY }}')" \
              # Param91ROLEPROJECTMANAGERValue="$(normalize '${{ secrets.ROLE_PROJECT_MANAGER }}')" \
              # Param92QP2APIKEYValue="$(normalize '${{ secrets.QP2_API_KEY }}')" \
              # Param93DEFAULTORIGINPARAMValue="$(normalize '${{ secrets.DEFAULT_ORIGIN_PARAM }}')" \
              # Param94ENVIRONMENTValue="$(normalize '${{ secrets.ENVIRONMENT }}')" \
              # Param95ENVIRONEMENTValue="$(normalize '${{ secrets.ENVIRONEMENT }}')" \
              # Param96ENVRONMENTValue="$(normalize '${{ secrets.ENVRONMENT }}')" \
              # Param97REMOTEBUCKETPATHValue="$(normalize '${{ secrets.REMOTE_BUCKET_PATH }}')" \
              # Param98SMTPCOIDETAILValue="$(normalize '${{ secrets.SMTP_COI_DETAIL }}')" \
              # Param99SNOWFLAKETABLEValue="$(normalize '${{ secrets.SNOWFLAKE_TABLE }}')" \
              # Param100CONTRACTAPIURLValue="$(normalize '${{ secrets.CONTRACT_API_URL }}')" \
              # Param101DISPATCHNOTIFICATIONValue="$(normalize '${{ secrets.DISPATCH_NOTIFICATION }}')"